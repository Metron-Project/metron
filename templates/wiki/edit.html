{% extends "wiki/article.html" %}
{% load wiki_tags i18n sekizai_tags %}
{% block wiki_pagetitle %}
    {% trans "Edit" %}: {{ article.current_revision.title }}
{% endblock %}
{% block wiki_contents_tab %}
    {% if not user.is_authenticated %}
        <div class="notification is-warning">
            <p>
                <strong>{% trans "Warning:" %}</strong> {% trans "You are not logged in. Your IP address will be logged." %}
                <a href="{% url 'wiki:login' %}?next={% url 'wiki:edit' article_id=article.id path=urlpath.path %}">{% trans "Click here to log in" %} &raquo;</a>
            </p>
        </div>
    {% endif %}
    <div class="columns">
        <div class="column is-two-thirds">
            <form method="POST" id="article_edit_form">
                {% with edit_form as form %}
                    {% include "wiki/includes/editor.html" %}
                {% endwith %}
                <div class="field is-grouped is-grouped-multiline">
                    <div class="control">
                        <button class="button is-rounded is-primary"
                                type="submit"
                                name="preview"
                                value="1"
                                id="id_preview"
                                formaction="{% url 'wiki:preview' path=urlpath.path article_id=article.id %}"
                                formtarget="previewWindow">
                            <span class="icon">
                                <i class="fas fa-eye"></i>
                            </span>
                            <span>{% trans "Preview" %}</span>
                        </button>
                    </div>
                    <div class="control">
                        <button class="button is-rounded is-link"
                                type="submit"
                                name="save"
                                value="1"
                                id="id_save">
                            <span class="icon">
                                <i class="fas fa-check"></i>
                            </span>
                            <span>{% trans "Save changes" %}</span>
                        </button>
                    </div>
                    {% if user.is_authenticated and urlpath.path %}
                        <div class="control">
                            <a href="{% url 'wiki:move' path=urlpath.path article_id=article.id %}"
                               class="button is-rounded is-warning">
                                <span class="icon">
                                    <i class="fas fa-random"></i>
                                </span>
                                <span>{% trans "Move article" %}</span>
                            </a>
                        </div>
                    {% endif %}
                    {% if article|can_delete:user %}
                        <div class="control">
                            <a href="{% url 'wiki:delete' path=urlpath.path article_id=article.id %}"
                               class="button is-rounded is-danger">
                                <span class="icon">
                                    <i class="fas fa-trash"></i>
                                </span>
                                <span>{% trans "Delete article" %}</span>
                            </a>
                        </div>
                    {% endif %}
                </div>
            </form>
        </div>
        <div class="column is-one-third" id="wiki-edit-sidebar">{% include "wiki/includes/editor_sidebar.html" %}</div>
    </div>
    {% include "wiki/includes/modals.html" %}
    <div class="modal" id="previewModal">
        <div class="modal-background"></div>
        <div class="modal-card is-large">
            <header class="modal-card-head has-background-link">
                <p class="modal-card-title has-text-white">
                    <span class="icon has-text-white">
                        <i class="fas fa-eye"></i>
                    </span>
                    <span>{% trans "Preview" %}</span>
                </p>
                <button class="delete" aria-label="close" id="closePreviewModal"></button>
            </header>
            <section class="modal-card-body" id="previewModalBody">
                <div class="box has-background-white-bis p-1">
                    <iframe name="previewWindow" class="preview-iframe"></iframe>
                </div>
            </section>
            <footer class="modal-card-foot has-background-light">
                <div class="buttons is-flex is-justify-content-space-between"
                     style="width: 100%">
                    <button class="button is-rounded is-light" id="closePreviewModalBtn">
                        <span class="icon">
                            <i class="fas fa-arrow-left"></i>
                        </span>
                        <span>{% trans "Back to editor" %}</span>
                    </button>
                    <button class="button is-rounded is-link" id="id_preview_save_changes">
                        <span class="icon">
                            <i class="fas fa-check"></i>
                        </span>
                        <span>{% trans "Save changes" %}</span>
                    </button>
                </div>
            </footer>
        </div>
    </div>
    {% addtoblock "css" %}
    <style>
  /* Enhanced modal styling with dark mode support */
  .modal-card.is-large {
    width: 90vw;
    max-width: 1200px;
    box-shadow: 0 0.5em 1em -0.125em rgba(10, 10, 10, 0.3), 0 0px 0 1px rgba(10, 10, 10, 0.05);
  }

  /* Modal header enhancements */
  .modal-card-head.has-background-link {
    border-bottom: 2px solid hsl(217, 71%, 45%);
  }

  /* Modal body with better padding and overflow handling */
  #previewModalBody {
    padding: 1rem;
    overflow: auto;
    background-color: hsl(0, 0%, 96%);
  }

  #previewModalBody .box {
    box-shadow: 0 2px 3px rgba(10, 10, 10, 0.1);
    overflow: hidden;
    background-color: hsl(0, 0%, 100%);
  }

  /* Iframe styling for preview - seamless display */
  .preview-iframe {
    width: 100%;
    min-height: 60vh;
    height: calc(90vh - 200px);
    border: none;
    background: transparent;
    border-radius: 4px;
    display: block;
  }

  /* Footer button layout */
  .modal-card-foot.has-background-light {
    padding: 1.25rem;
    border-top: 2px solid hsl(0, 0%, 86%);
  }

  /* Improve button spacing in footer */
  .modal-card-foot .buttons {
    margin-bottom: 0;
  }

  /* Dark mode support for modal */
  @media (prefers-color-scheme: dark) {
    .modal-card.is-large {
      box-shadow: 0 0.5em 1em -0.125em rgba(0, 0, 0, 0.5), 0 0px 0 1px rgba(0, 0, 0, 0.2);
    }

    #previewModalBody {
      background-color: hsl(0, 0%, 21%);
    }

    #previewModalBody .box {
      background-color: hsl(0, 0%, 14%);
      box-shadow: 0 2px 3px rgba(0, 0, 0, 0.3);
    }

    .modal-card-head.has-background-link {
      background-color: hsl(217, 71%, 35%) !important;
      border-bottom-color: hsl(217, 71%, 30%);
    }

    .modal-card-foot.has-background-light {
      background-color: hsl(0, 0%, 17%) !important;
      border-top-color: hsl(0, 0%, 29%);
    }

    .modal-background {
      background-color: rgba(0, 0, 0, 0.7);
    }
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .modal-card.is-large {
      border: 3px solid currentColor;
    }

    .modal-card-head.has-background-link {
      border-bottom-width: 3px;
    }

    .modal-card-foot.has-background-light {
      border-top-width: 3px;
    }
  }

  /* Reduced motion support */
  @media (prefers-reduced-motion: reduce) {
    .modal-card.is-large {
      animation: none;
    }
  }
    </style>
{% endaddtoblock %}
{% addtoblock "js" %}
<script language="javascript">
  $(document).ready(function() {
    $("#article_edit_form :input").change(function() {
       $("#article_edit_form").data("changed",true);
    });
    if ($("#article_edit_form").find(".notification.is-danger").length > 0 || $("#article_edit_form").find(".has-error").length > 0 ) {
      // Set the forms status as "changed" if there was a submission error
      $("#article_edit_form").data("changed",true);
    }
    window.onbeforeunload = confirmOnPageExit;
    var click_time = 0;
    $("#article_edit_form").on("submit", function (ev) {
        now = Date.now();
        elapsed = now-click_time;
        click_time = now;
        if (elapsed < 3000)
            ev.preventDefault();
        window.onbeforeunload = null;
        return true;
    });
    // Open preview modal when preview button is clicked
    $("#id_preview").on("click", function () {
        $("#previewModal").addClass("is-active");
        // Trigger iframe resize after modal opens
        setTimeout(function() {
            if (typeof resizeBulmaModalIframe === 'function') {
                resizeBulmaModalIframe();
            }
        }, 150);
        return true;
    });

    // Close preview modal handlers
    function closePreviewModal() {
        $("#previewModal").removeClass("is-active");
    }

    $("#previewModal .modal-background").on("click", closePreviewModal);
    $("#closePreviewModal").on("click", closePreviewModal);
    $("#closePreviewModalBtn").on("click", closePreviewModal);

    // Save changes from preview modal
    $("#id_preview_save_changes").on("click", function (ev) {
        ev.preventDefault();
        closePreviewModal();
        $("#id_save").trigger("click");
    });
  });

var confirmOnPageExit = function (e) {
  if ($("#article_edit_form").data("changed")) {
    e = e || window.event;
    var message = "You have unsaved changes!";
    // For IE6-8 and Firefox prior to version 4
    if (e) {
        e.returnValue = message;
    }
    // For Chrome, Safari, IE8+ and Opera 12+
    return message;
  } else {
    // If the form hasn't been changed, don't display the pop-up
    return;
  }
};
</script>
{% endaddtoblock %}
{% endblock %}

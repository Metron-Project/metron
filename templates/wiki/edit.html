{% extends "wiki/article.html" %}
{% load wiki_tags i18n sekizai_tags %}


{% block wiki_pagetitle %}{% trans "Edit" %}: {{ article.current_revision.title }}{% endblock %}

{% block wiki_contents_tab %}

{% if not user.is_authenticated %}
<div class="notification is-warning">
  <p>
    <strong>{% trans "Warning:" %}</strong> {% trans "You are not logged in. Your IP address will be logged." %}
    <a href="{% url 'wiki:login' %}?next={% url 'wiki:edit' article_id=article.id path=urlpath.path %}">{% trans "Click here to log in" %} &raquo;</a>
  </p>
</div>
{% endif %}

<div class="columns">
  <div class="column is-two-thirds">
    <form method="POST" id="article_edit_form">
      {% with edit_form as form %}
        {% include "wiki/includes/editor.html" %}
      {% endwith %}

      <div class="field is-grouped is-grouped-multiline">
        <div class="control">
          <button class="button is-rounded is-primary" type="submit" name="preview" value="1" id="id_preview"
                  formaction="{% url 'wiki:preview' path=urlpath.path article_id=article.id %}"
                  formtarget="previewWindow">
            <span class="icon">
              <i class="fas fa-eye"></i>
            </span>
            <span>{% trans "Preview" %}</span>
          </button>
        </div>
        <div class="control">
          <button class="button is-rounded is-link" type="submit" name="save" value="1" id="id_save">
            <span class="icon">
              <i class="fas fa-check"></i>
            </span>
            <span>{% trans "Save changes" %}</span>
          </button>
        </div>
        {% if user.is_authenticated and urlpath.path %}
        <div class="control">
          <a href="{% url 'wiki:move' path=urlpath.path article_id=article.id %}" class="button is-rounded is-warning">
            <span class="icon">
              <i class="fas fa-random"></i>
            </span>
            <span>{% trans "Move article" %}</span>
          </a>
        </div>
        {% endif %}
        {% if article|can_delete:user %}
        <div class="control">
          <a href="{% url 'wiki:delete' path=urlpath.path article_id=article.id %}" class="button is-rounded is-danger">
            <span class="icon">
              <i class="fas fa-trash"></i>
            </span>
            <span>{% trans "Delete article" %}</span>
          </a>
        </div>
        {% endif %}
      </div>
    </form>
  </div>

  <div class="column is-one-third" id="wiki-edit-sidebar">
    {% include "wiki/includes/editor_sidebar.html" %}
  </div>
</div>

{% include "wiki/includes/modals.html" %}

<div class="modal" id="previewModal">
  <div class="modal-background"></div>
  <div class="modal-card is-large">
    <header class="modal-card-head">
      <p class="modal-card-title">
        <span class="icon">
          <i class="fa fa-eye"></i>
        </span>
        <span>{% trans "Preview" %}</span>
      </p>
      <button class="delete" aria-label="close" id="closePreviewModal"></button>
    </header>
    <section class="modal-card-body" id="previewModalBody">
      <iframe name="previewWindow" class="preview-iframe"></iframe>
    </section>
    <footer class="modal-card-foot is-justify-content-space-between">
      <button class="button is-rounded" id="closePreviewModalBtn">
        <span class="icon">
          <i class="fa fa-arrow-circle-left"></i>
        </span>
        <span>{% trans "Back to editor" %}</span>
      </button>
      <button class="button is-rounded is-link" id="id_preview_save_changes">
        <span class="icon">
          <i class="fa fa-check"></i>
        </span>
        <span>{% trans "Save changes" %}</span>
      </button>
    </footer>
  </div>
</div>

{% addtoblock "css" %}
<style>
  .modal-card.is-large {
    width: 90vw;
    max-width: 1200px;
  }

  #previewModalBody {
    padding: 0;
    overflow: hidden;
  }

  .preview-iframe {
    width: 100%;
    min-height: 60vh;
    height: calc(90vh - 200px);
    border: none;
    background: #fff;
  }

  .modal-card-foot.is-justify-content-space-between {
    justify-content: space-between;
  }
</style>
{% endaddtoblock %}

{% addtoblock "js" %}
<script language="javascript">
  $(document).ready(function() {
    $("#article_edit_form :input").change(function() {
       $("#article_edit_form").data("changed",true);
    });
    if ($("#article_edit_form").find(".notification.is-danger").length > 0 || $("#article_edit_form").find(".has-error").length > 0 ) {
      // Set the forms status as "changed" if there was a submission error
      $("#article_edit_form").data("changed",true);
    }
    window.onbeforeunload = confirmOnPageExit;
    var click_time = 0;
    $("#article_edit_form").on("submit", function (ev) {
        now = Date.now();
        elapsed = now-click_time;
        click_time = now;
        if (elapsed < 3000)
            ev.preventDefault();
        window.onbeforeunload = null;
        return true;
    });
    // Open preview modal when preview button is clicked
    $("#id_preview").on("click", function () {
        $("#previewModal").addClass("is-active");
        // Trigger iframe resize after modal opens
        setTimeout(function() {
            if (typeof resizeBulmaModalIframe === 'function') {
                resizeBulmaModalIframe();
            }
        }, 150);
        return true;
    });

    // Close preview modal handlers
    function closePreviewModal() {
        $("#previewModal").removeClass("is-active");
    }

    $("#previewModal .modal-background").on("click", closePreviewModal);
    $("#closePreviewModal").on("click", closePreviewModal);
    $("#closePreviewModalBtn").on("click", closePreviewModal);

    // Save changes from preview modal
    $("#id_preview_save_changes").on("click", function (ev) {
        ev.preventDefault();
        closePreviewModal();
        $("#id_save").trigger("click");
    });
  });

var confirmOnPageExit = function (e) {
  if ($("#article_edit_form").data("changed")) {
    e = e || window.event;
    var message = "You have unsaved changes!";
    // For IE6-8 and Firefox prior to version 4
    if (e) {
        e.returnValue = message;
    }
    // For Chrome, Safari, IE8+ and Opera 12+
    return message;
  } else {
    // If the form hasn't been changed, don't display the pop-up
    return;
  }
};
</script>
{% endaddtoblock %}

{% endblock %}

{% extends parent_template|default:"base.html" %}
{% load static %}
{% load thumbnail %}
{% load django_htmx %}
{% block title %}{{ item.issue }} - My Collection - Metron{% endblock %}
{% block headcss %}
    <link rel="stylesheet"
          href="{% static 'site/css/bulma-calendar.min.css' %}">
{% endblock %}
{% block content %}
    <header class="block">
        <h1 class="title">Collection Item Details</h1>
    </header>
    <nav class="level mb-5">
        <div class="level-left">
            <div class="level-item">
                <a class="button is-rounded" href="{% url 'user_collection:list' %}">
                    <span class="icon"><i class="fas fa-arrow-left"></i></span>
                    <span>Back to Collection</span>
                </a>
            </div>
        </div>
        <div class="level-right">
            <div class="buttons">
                <a class="button is-rounded is-info"
                   href="{% url 'user_collection:update' item.pk %}">
                    <span class="icon is-small"><i class="fas fa-edit"></i></span>
                    <span>Edit</span>
                </a>
                <a class="button is-rounded is-danger"
                   href="{% url 'user_collection:delete' item.pk %}">
                    <span class="icon is-small"><i class="fas fa-trash"></i></span>
                    <span>Remove</span>
                </a>
            </div>
        </div>
    </nav>
    <div class="columns">
        <div class="column is-narrow">
            {% if item.issue.image %}
                <div class="box has-text-centered">
                    <figure class="image is-inline-block">
                        {% thumbnail item.issue.image "300x460" crop="center" as im %}
                            <img src="{{ im.url }}"
                                 alt="{{ item.issue }}"
                                 width="{{ im.width }}"
                                 height="{{ im.height }}"
                                 loading="lazy">
                        {% empty %}
                            <img src="{{ item.issue.image.url }}"
                                 alt="{{ item.issue }}"
                                 style="max-width: 300px"
                                 loading="lazy">
                        {% endthumbnail %}
                    </figure>
                </div>
            {% endif %}
        </div>
        <div class="column">
            <div class="box">
                <h2 class="title is-5">Issue Information</h2>
                <div class="content">
                    <dl>
                        <dt class="has-text-weight-bold">Issue:</dt>
                        <dd class="mb-3">
                            <a href="{% url 'issue:detail' item.issue.slug %}">{{ item.issue }}</a>
                        </dd>
                        <dt class="has-text-weight-bold">Series:</dt>
                        <dd class="mb-3">
                            <a href="{% url 'series:detail' item.issue.series.slug %}">{{ item.issue.series.name }}</a>
                        </dd>
                        <dt class="has-text-weight-bold">Publisher:</dt>
                        <dd class="mb-3">
                            <a href="{% url 'publisher:detail' item.issue.series.publisher.slug %}">{{ item.issue.series.publisher.name }}</a>
                        </dd>
                        <dt class="has-text-weight-bold">Cover Date:</dt>
                        <dd class="mb-3">
                            {{ item.issue.cover_date|date:"F Y" }}
                        </dd>
                    </dl>
                </div>
            </div>
            {% if item.issue.desc %}
                <div class="box">
                    <h2 class="title is-5">Description</h2>
                    <div class="content">{{ item.issue.desc|linebreaksbr }}</div>
                </div>
            {% endif %}
            {% if item.grade %}
                <div class="box">
                    <h2 class="title is-5">Grading Information</h2>
                    <dl>
                        <dt class="has-text-weight-bold">Grade:</dt>
                        <dd class="mb-3">
                            <span class="tag is-primary is-medium">
                                <span class="icon is-small">
                                    <i class="fas fa-star"></i>
                                </span>
                                <span>{{ item.get_grade_display }}</span>
                            </span>
                        </dd>
                        <dt class="has-text-weight-bold">Grading Type:</dt>
                        <dd>
                            {% if item.grading_company %}
                                <span class="icon is-small has-text-info">
                                    <i class="fas fa-certificate"></i>
                                </span>
                                <span>Professionally graded by {{ item.get_grading_company_display }}</span>
                            {% else %}
                                <span class="icon is-small has-text-grey">
                                    <i class="fas fa-user"></i>
                                </span>
                                <span>User-assessed grade</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            {% endif %}
            {% if item.notes %}
                <div class="box">
                    <h2 class="title is-5">Notes</h2>
                    <div class="content">{{ item.notes|linebreaksbr }}</div>
                </div>
            {% endif %}
        </div>
        <div class="column is-one-quarter">
            <div class="box">
                <h2 class="title is-6">Collection Details</h2>
                <dl>
                    <dt class="has-text-weight-bold">Format:</dt>
                    <dd class="mb-3">
                        <span class="tag {% if item.book_format == 'DIGITAL' %}is-info{% elif item.book_format == 'BOTH' %}is-success{% else %}is-dark{% endif %}">
                            {{ item.get_book_format_display }}
                        </span>
                    </dd>
                    <dt class="has-text-weight-bold">Quantity:</dt>
                    <dd class="mb-3">
                        {{ item.quantity }}
                    </dd>
                    {% if item.purchase_date %}
                        <dt class="has-text-weight-bold">Purchase Date:</dt>
                        <dd class="mb-3">
                            {{ item.purchase_date|date:"F d, Y" }}
                        </dd>
                    {% endif %}
                    {% if item.purchase_price %}
                        <dt class="has-text-weight-bold">Price Paid:</dt>
                        <dd class="mb-3">
                            {{ item.purchase_price }}
                        </dd>
                    {% endif %}
                    {% if item.purchase_store %}
                        <dt class="has-text-weight-bold">Store/Vendor:</dt>
                        <dd class="mb-3">
                            {{ item.purchase_store }}
                        </dd>
                    {% endif %}
                    {% if item.storage_location %}
                        <dt class="has-text-weight-bold">Storage Location:</dt>
                        <dd class="mb-3">
                            {{ item.storage_location }}
                        </dd>
                    {% endif %}
                    <dt class="has-text-weight-bold">Read Status:</dt>
                    <dd class="mb-3">
                        {% if item.is_read %}
                            <span class="tag is-success">
                                <span class="icon"><i class="fas fa-check"></i></span>
                                <span>Read</span>
                            </span>
                        {% else %}
                            <span class="tag is-warning">
                                <span class="icon"><i class="fas fa-clock"></i></span>
                                <span>Unread</span>
                            </span>
                        {% endif %}
                    </dd>
                    <dt class="has-text-weight-bold">Rating:</dt>
                    <dd class="mb-3">
                        {% include "user_collection/partials/star_rating.html" %}
                    </dd>
                    <dt class="has-text-weight-bold">Read History:</dt>
                    <dd class="mb-3" id="read-dates-container">
                        {% include "user_collection/partials/read_dates_list.html" %}
                    </dd>
                    <dt class="has-text-weight-bold">Added to Collection:</dt>
                    <dd class="mb-3">
                        {{ item.created_on|date:"F d, Y" }}
                    </dd>
                    <dt class="has-text-weight-bold">Last Modified:</dt>
                    <dd>
                        {{ item.modified|date:"F d, Y" }}
                    </dd>
                </dl>
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    {% htmx_script %}
    <script src="{% static 'extensions/bulma-calendar/dist/js/bulma-calendar.min.js' %}"></script>
    <script src="{% static 'site/js/bulma-modal.js' %}"></script>
    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });

        // Initialize Bulma Calendar for datetime inputs
        function initializeDateTimePickers() {
            var calendarInputs = document.querySelectorAll('input[data-bulma-calendar="on"]');

            calendarInputs.forEach(function(input) {
                var dataType = input.getAttribute('data-type');
                var isDateTime = dataType === 'datetime';

                var config = {
                    type: isDateTime ? 'datetime' : 'date',
                    dateFormat: 'yyyy-MM-dd',
                    timeFormat: 'HH:mm',
                    displayMode: 'default',
                    showHeader: true,
                    closeOnSelect: !isDateTime,
                    clearButton: false,
                    todayButton: true,
                    showFooter: true,
                    weekStart: 0,
                    showClearButton: false,
                    showTodayButton: true,
                    closeOnOverlayClick: true
                };

                bulmaCalendar.attach(input, config);
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeDateTimePickers);

        // Re-initialize after HTMX swaps content
        document.body.addEventListener('htmx:afterSwap', initializeDateTimePickers);
    </script>
{% endblock %}

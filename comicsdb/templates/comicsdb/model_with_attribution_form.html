{% extends parent_template|default:"base.html" %}
{% load static %}
{% load bulma_tags %}
{% block title %}
    {{ title|default:"Form" }}
{% endblock title %}
{% block headcss %}
    {{ form.media.css }}
    <link rel="stylesheet"
          href="{% static 'site/css/bulma-calendar.min.css' %}">
{% endblock %}
{% block content %}
    <header class="block has-text-centered">
        <h1 class="title">{{ title|default:"Form" }}</h1>
    </header>
    <form method="post" enctype="multipart/form-data" id="mainForm" novalidate>
        {% csrf_token %}
        <!-- Primary Information Section -->
        <div class="box">
            <h2 class="title is-5">Primary Information</h2>
            {% include "comicsdb/partials/form_errors.html" with form=form %}
            {% for field in form.hidden_fields %}{{ field }}{% endfor %}
            {% for field in form.visible_fields %}
                {% include "comicsdb/partials/form_field.html" with field=field %}
            {% endfor %}
        </div>
        <!-- Attribution Section -->
        <div class="box">
            <h2 class="title is-5">Attribution</h2>
            {% include "comicsdb/partials/attribution_formset.html" with formset=attribution %}
        </div>
        <!-- Submit Button -->
        <div class="field">
            <div class="control">
                <button class="button is-rounded is-info" type="submit">
                    <span class="icon">
                        <i class="fas fa-check"></i>
                    </span>
                    <span>Submit</span>
                </button>
            </div>
        </div>
    </form>
{% endblock %}
{% block js %}
    {{ form.media.js }}
    <script src="{% static 'site/js/bulma-fileupload.js' %}"></script>
    <script src="{% static 'extensions/bulma-calendar/dist/js/bulma-calendar.min.js' %}"></script>
    <script>
document.addEventListener('DOMContentLoaded', function() {
    'use strict';

    // Initialize bulma-calendar for date inputs
    var dateInputs = document.querySelectorAll('input[data-bulma-calendar="on"]');
    dateInputs.forEach(function(input) {
        bulmaCalendar.attach(input, {
            type: 'date',
            dateFormat: 'yyyy-MM-dd',
            displayMode: 'default',
            showHeader: true,
            closeOnSelect: true,
            clearButton: false,
            todayButton: true,
            showFooter: true,
            weekStart: 0
        });
    });
});

/**
 * Get the next form index for a formset
 * @param {string} prefix - The formset prefix (e.g., 'attribution')
 * @returns {number} The next form index
 */
function getNextFormIndex(prefix) {
    var totalFormsInput = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);
    return parseInt(totalFormsInput.value);
}

/**
 * Update the formset management form after adding or removing rows
 * @param {string} prefix - The formset prefix (e.g., 'attribution')
 * @param {number} increment - The number to increment (1 for add, -1 for remove, or 0 to recalculate)
 */
function updateFormsetManagement(prefix, increment = 0) {
    var totalFormsInput = document.querySelector(`#id_${prefix}-TOTAL_FORMS`);

    if (increment !== 0) {
        // Simple increment/decrement
        var currentTotal = parseInt(totalFormsInput.value);
        totalFormsInput.value = currentTotal + increment;
    } else {
        // Recalculate based on actual rows in the table
        var tbody = document.querySelector(`#${prefix}TableBody`);
        if (tbody) {
            var rows = tbody.querySelectorAll('tr.formset-row');
            totalFormsInput.value = rows.length;
        }
    }
}

// Listen for htmx events to handle autocomplete widget initialization on new rows
document.body.addEventListener('htmx:afterSwap', function(event) {
    // Check if this was a formset row addition
    if (event.detail.target.id && event.detail.target.id.includes('TableBody')) {
        // Trigger any autocomplete initialization if needed
        var newRow = event.detail.target.lastElementChild;
        if (newRow && window.autocomplete && window.autocomplete.init) {
            // Initialize autocomplete widgets in the new row
            var autocompleteInputs = newRow.querySelectorAll('[data-autocomplete]');
            autocompleteInputs.forEach(function(input) {
                window.autocomplete.init(input);
            });
        }
    }
});
    </script>
{% endblock %}
